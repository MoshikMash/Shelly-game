<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üëó Style Battle!</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">



<style>
* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }

:root {
  --p1: #f472b6;
  --p2: #818cf8;
  --gold: #fbbf24;
  --text: #2d1b4e;
  --bg: #fdf4ff;
  --card: #ffffff;
  --soft: #9d7ec0;
}

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  min-height: 100vh;
  background-image:
    radial-gradient(circle at 20% 20%, #fce7f3 0%, transparent 40%),
    radial-gradient(circle at 80% 80%, #ede9fe 0%, transparent 40%);
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display:none; min-height:100vh; flex-direction:column; align-items:center; justify-content:center; padding:1.5rem 1rem; }
.screen.active { display:flex; }

/* ‚îÄ‚îÄ HOME SCREEN ‚îÄ‚îÄ */
.logo {
  font-family:'Fredoka One',cursive;
  font-size:clamp(2.2rem,8vw,3.5rem);
  background:linear-gradient(135deg,var(--p1),var(--p2));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  text-align:center; filter:drop-shadow(0 3px 12px rgba(244,114,182,0.35));
  margin-bottom:0.3rem;
}
.logo-sub { color:var(--soft); font-weight:700; font-size:1rem; text-align:center; margin-bottom:2rem; }

.home-btns { display:flex; flex-direction:column; gap:0.8rem; width:100%; max-width:320px; }

.big-btn {
  border:none; border-radius:18px; padding:1rem 1.5rem;
  font-family:'Nunito',sans-serif; font-weight:900; font-size:1.1rem;
  color:white; cursor:pointer; transition:all 0.2s;
  box-shadow:0 6px 20px rgba(0,0,0,0.12);
  display:flex; align-items:center; gap:0.7rem; justify-content:center;
}
.big-btn.create { background:linear-gradient(135deg,var(--p1),#ec4899); }
.big-btn.join   { background:linear-gradient(135deg,var(--p2),#6366f1); }
.big-btn.solo   { background:linear-gradient(135deg,#34d399,#0891b2); }
.big-btn:hover  { transform:translateY(-3px) scale(1.02); }
.big-btn:active { transform:scale(0.97); }
.big-btn .bicon { font-size:1.4rem; }

/* ‚îÄ‚îÄ JOIN SCREEN ‚îÄ‚îÄ */
.join-card {
  background:white; border-radius:2rem; padding:2rem;
  box-shadow:0 12px 40px rgba(0,0,0,0.1); width:100%; max-width:340px;
  display:flex; flex-direction:column; gap:1rem; align-items:center;
}
.join-card h2 { font-family:'Fredoka One',cursive; color:var(--p2); font-size:1.6rem; }
.join-card p  { color:var(--soft); font-weight:600; font-size:0.9rem; text-align:center; }

.code-input {
  width:100%; border:3px solid var(--p2); border-radius:14px;
  padding:0.8rem; font-family:'Fredoka One',cursive; font-size:2rem;
  text-align:center; color:var(--text); background:#ede9fe; outline:none;
  letter-spacing:6px; text-transform:uppercase;
}
.code-input:focus { box-shadow:0 0 0 4px rgba(129,140,248,0.2); }

.name-input-lg {
  width:100%; border:2.5px solid #e9d5ff; border-radius:14px;
  padding:0.7rem 1rem; font-family:'Nunito',sans-serif; font-weight:800;
  font-size:1rem; color:var(--text); background:#fdf4ff; outline:none;
  text-align:center;
}
.name-input-lg:focus { border-color:var(--p1); }

/* ‚îÄ‚îÄ WAITING SCREEN ‚îÄ‚îÄ */
.wait-card {
  background:white; border-radius:2rem; padding:2rem 2.5rem;
  box-shadow:0 12px 40px rgba(0,0,0,0.1); width:100%; max-width:340px;
  text-align:center; display:flex; flex-direction:column; gap:1rem; align-items:center;
}
.room-code-display {
  background:linear-gradient(135deg,var(--p1),var(--p2));
  color:white; border-radius:16px; padding:0.8rem 1.5rem;
  font-family:'Fredoka One',cursive; font-size:2.8rem; letter-spacing:6px;
  box-shadow:0 6px 20px rgba(244,114,182,0.3);
}
.wait-msg { color:var(--soft); font-weight:700; font-size:0.9rem; }
.wait-dots span { animation:bounce 1.2s infinite; display:inline-block; }
.wait-dots span:nth-child(2){ animation-delay:0.2s; }
.wait-dots span:nth-child(3){ animation-delay:0.4s; }
@keyframes bounce { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-8px)} }

.copy-btn {
  background:#ede9fe; border:none; border-radius:12px; padding:0.5rem 1rem;
  font-family:'Nunito',sans-serif; font-weight:800; font-size:0.85rem;
  color:var(--p2); cursor:pointer; transition:all 0.2s;
}
.copy-btn:hover { background:var(--p2); color:white; }

/* ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ */
#gameScreen {
  justify-content:flex-start; padding:0.5rem 0.7rem 1.5rem;
}

/* Theme banner */
.theme-pill {
  background:linear-gradient(135deg,var(--p1),var(--p2));
  border-radius:20px; padding:0.5rem 1.2rem;
  font-family:'Fredoka One',cursive; font-size:1.1rem;
  color:white; text-align:center; width:100%; max-width:420px;
  box-shadow:0 4px 14px rgba(244,114,182,0.3); margin-bottom:0.3rem;
}
.theme-kw { font-size:0.72rem; color:rgba(255,255,255,0.85); font-weight:700; margin-top:0.1rem; }

/* Timer */
.timer-row { display:flex; align-items:center; gap:0.6rem; width:100%; max-width:420px; margin-bottom:0.4rem; }
.timer-track { flex:1; height:10px; background:#e9d5ff; border-radius:20px; overflow:hidden; }
.timer-fill  { height:100%; border-radius:20px; transition:width 1s linear; background:linear-gradient(90deg,var(--p1),var(--p2)); }
.timer-num   { font-family:'Fredoka One',cursive; font-size:1.1rem; color:var(--p1); min-width:2rem; text-align:right; }

/* Players area - MOBILE: stacked, WIDE: side by side */
.players-area {
  display:flex; flex-direction:column; gap:0.8rem;
  width:100%; max-width:420px;
}
@media(min-width:700px){
  .players-area { flex-direction:row; max-width:860px; }
  #gameScreen { align-items:center; }
  .theme-pill, .timer-row, .bottom-ctrls { max-width:860px; }
}

/* Player card */
.pcard {
  flex:1; background:white; border-radius:1.5rem; padding:0.9rem;
  box-shadow:0 6px 24px rgba(0,0,0,0.08); border:3px solid transparent;
  display:flex; flex-direction:column; align-items:center; gap:0.5rem;
  transition:border-color 0.4s, box-shadow 0.4s;
}
.pcard.me   { border-color:rgba(244,114,182,0.4); }
.pcard.them { border-color:rgba(129,140,248,0.4); }
.pcard.winner { box-shadow:0 0 0 3px var(--gold), 0 10px 30px rgba(251,191,36,0.4); animation:glow 1s ease infinite; }
@keyframes glow { 0%,100%{box-shadow:0 0 0 3px var(--gold),0 10px 30px rgba(251,191,36,0.3)} 50%{box-shadow:0 0 0 6px var(--gold),0 14px 40px rgba(251,191,36,0.5)} }

.pcard-header { width:100%; display:flex; align-items:center; justify-content:space-between; }
.pname { font-weight:900; font-size:0.95rem; color:var(--text); }
.pname .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:5px; }
.pme-badge { background:var(--p1); color:white; font-size:0.65rem; font-weight:800; padding:0.15rem 0.5rem; border-radius:10px; }
.pthem-badge { background:var(--p2); color:white; font-size:0.65rem; font-weight:800; padding:0.15rem 0.5rem; border-radius:10px; }
.pscore { font-family:'Fredoka One',cursive; font-size:0.95rem; color:var(--gold); }

/* SVG char - smaller for mobile */
.char-box { width:130px; height:220px; }
@media(min-width:700px){ .char-box { width:160px; height:270px; } }
.char-box svg { width:100%; height:100%; overflow:visible; }

/* Tags */
.ptags { display:flex; flex-wrap:wrap; gap:0.25rem; justify-content:center; min-height:20px; width:100%; }
.ptag  { border-radius:20px; padding:0.1rem 0.45rem; font-size:0.65rem; font-weight:800; animation:pop 0.3s cubic-bezier(.68,-0.55,.27,1.55); }
.me .ptag   { background:#fce7f3; border:1.5px solid var(--p1); color:var(--text); }
.them .ptag { background:#ede9fe; border:1.5px solid var(--p2); color:var(--text); }
@keyframes pop { from{transform:scale(0)} to{transform:scale(1)} }

/* Input ‚Äî only show on MY card */
.my-input-area { width:100%; display:flex; flex-direction:column; gap:0.4rem; }
.in-row { display:flex; gap:0.35rem; }
.pin {
  flex:1; border:2.5px solid var(--p1); border-radius:12px;
  padding:0.55rem 0.7rem; font-family:'Nunito',sans-serif; font-weight:700;
  font-size:0.9rem; color:var(--text); background:#fdf4ff; outline:none;
}
.pin:focus { box-shadow:0 0 0 3px rgba(244,114,182,0.2); }
.pin::placeholder { color:#f9a8d4; }
.pgo {
  border:none; border-radius:12px; padding:0.55rem 0.8rem;
  background:linear-gradient(135deg,var(--p1),#ec4899);
  color:white; font-weight:800; font-size:1rem; cursor:pointer; transition:all 0.2s;
}
.pgo:hover { transform:scale(1.08); }

.pfb { font-size:0.72rem; font-weight:700; min-height:1.2rem; text-align:center; border-radius:8px; padding:0.1rem 0.4rem; }
.pfb.ok  { color:#15803d; background:#dcfce7; }
.pfb.err { color:#b91c1c; background:#fee2e2; animation:shake 0.35s; }
@keyframes shake { 0%,100%{transform:translateX(0)} 30%{transform:translateX(-4px)} 70%{transform:translateX(4px)} }

.waiting-them { color:var(--soft); font-size:0.78rem; font-weight:700; text-align:center; animation:pulse 2s ease infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* Bottom controls */
.bottom-ctrls { display:flex; gap:0.5rem; width:100%; max-width:420px; margin-top:0.3rem; }
@media(min-width:700px){ .bottom-ctrls { max-width:860px; } }

.ctrl {
  flex:1; border:none; border-radius:12px; padding:0.6rem 0.5rem;
  font-family:'Nunito',sans-serif; font-weight:800; font-size:0.82rem;
  cursor:pointer; transition:all 0.2s;
}
.ctrl.primary { background:linear-gradient(135deg,var(--p1),var(--p2)); color:white; box-shadow:0 4px 12px rgba(244,114,182,0.3); }
.ctrl.secondary { background:white; color:var(--soft); border:2px solid #e9d5ff; }
.ctrl:hover { transform:translateY(-2px); }

/* Hint chips - compact row */
.hints-scroll {
  width:100%; max-width:420px; overflow-x:auto; display:flex; gap:0.35rem;
  padding:0.2rem 0; scrollbar-width:none; margin-bottom:0.2rem;
}
@media(min-width:700px){ .hints-scroll { max-width:860px; flex-wrap:wrap; } }
.hints-scroll::-webkit-scrollbar { display:none; }
.hc {
  flex-shrink:0; background:white; border:2px solid #e9d5ff; border-radius:20px;
  padding:0.2rem 0.6rem; font-size:0.72rem; font-weight:700; color:var(--soft);
  cursor:pointer; transition:all 0.15s; white-space:nowrap;
  font-family:'Nunito',sans-serif;
}
.hc:hover, .hc:active { background:var(--p1); color:white; border-color:var(--p1); }

/* Result overlay */
.overlay { position:fixed; inset:0; background:rgba(45,27,78,0.75); backdrop-filter:blur(6px); z-index:100; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.4s; }
.overlay.show { opacity:1; pointer-events:all; }
.res-card { background:white; border-radius:2rem; padding:2rem 1.5rem; text-align:center; box-shadow:0 24px 80px rgba(0,0,0,0.3); max-width:340px; width:90%; animation:rPop 0.5s cubic-bezier(.68,-0.55,.27,1.55); }
@keyframes rPop { from{transform:scale(0.5);opacity:0} to{transform:scale(1);opacity:1} }
.res-trophy { font-size:3.5rem; }
.res-title { font-family:'Fredoka One',cursive; font-size:1.8rem; background:linear-gradient(135deg,var(--p1),var(--p2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
.res-scores { display:flex; gap:0.8rem; justify-content:center; margin:0.8rem 0; }
.rscore { padding:0.5rem 0.8rem; border-radius:12px; font-weight:800; }
.rscore.p1c { background:#fce7f3; color:var(--p1); border:2px solid var(--p1); }
.rscore.p2c { background:#ede9fe; color:var(--p2); border:2px solid var(--p2); }
.rscore .sv { font-family:'Fredoka One',cursive; font-size:1.4rem; }
.rscore .sn { font-size:0.72rem; }
.res-reason { color:var(--soft); font-size:0.82rem; font-weight:600; margin-bottom:1rem; line-height:1.5; }

/* Phase screen */
.phase-screen { position:fixed; inset:0; background:linear-gradient(135deg,var(--p1),var(--p2)); z-index:120; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.8rem; opacity:0; pointer-events:none; transition:opacity 0.3s; }
.phase-screen.show { opacity:1; pointer-events:all; }
.phase-big { font-family:'Fredoka One',cursive; font-size:clamp(2.5rem,8vw,4.5rem); color:white; text-align:center; text-shadow:0 4px 20px rgba(0,0,0,0.2); padding:0 1rem; }
.phase-kw { background:rgba(255,255,255,0.2); border-radius:1rem; padding:0.6rem 1.2rem; color:white; font-weight:700; font-size:0.85rem; text-align:center; margin:0 1rem; }

/* Confetti */
.cf { position:fixed; pointer-events:none; z-index:200; border-radius:3px; animation:cfFall 1.8s ease-in forwards; }
@keyframes cfFall { from{transform:translateY(-30px) rotate(0deg);opacity:1} to{transform:translateY(105vh) rotate(600deg);opacity:0} }

/* Connection status */
.conn-status { position:fixed; top:0.5rem; right:0.5rem; font-size:0.7rem; font-weight:700; padding:0.2rem 0.6rem; border-radius:10px; z-index:50; }
.conn-status.online  { background:#dcfce7; color:#15803d; }
.conn-status.offline { background:#fee2e2; color:#b91c1c; }
.conn-status.local   { background:#fef9c3; color:#92400e; }
</style>
</head>
<body>

<!-- Connection status indicator -->
<div class="conn-status offline" id="connStatus">‚ö™ Not Connected</div>

<!-- Phase announcement -->
<div class="phase-screen" id="phaseScreen">
  <div style="font-size:3rem" id="phaseEmoji">üëë</div>
  <div class="phase-big" id="phaseBig">Get Ready!</div>
  <div class="phase-kw" id="phaseKw"></div>
</div>

<!-- Result overlay -->
<div class="overlay" id="overlay">
  <div class="res-card">
    <div class="res-trophy" id="rTrophy">üèÜ</div>
    <div class="res-title" id="rTitle">Round Over!</div>
    <div style="font-weight:800;color:var(--text);margin:0.3rem 0;font-size:1rem" id="rWinner"></div>
    <div class="res-scores">
      <div class="rscore p1c"><div class="sn" id="rN1">P1</div><div class="sv" id="rS1">0</div></div>
      <div class="rscore p2c"><div class="sn" id="rN2">P2</div><div class="sv" id="rS2">0</div></div>
    </div>
    <div class="res-reason" id="rReason"></div>
    <button class="ctrl primary" style="width:100%" onclick="nextRound()">‚ñ∂ Next Round!</button>
    <button class="ctrl secondary" style="width:100%;margin-top:0.4rem" onclick="goHome()">üè† Home</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  SCREEN 1: HOME                 -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="homeScreen">
  <div class="logo">üëó Style Battle!</div>
  <div class="logo-sub">The dress-up competition game üíÖ</div>

  <div class="home-btns">
    <button class="big-btn create" onclick="showCreate()">
      <span class="bicon">üéÆ</span> Create Room
    </button>
    <button class="big-btn join" onclick="showJoin()">
      <span class="bicon">üîó</span> Join with Code
    </button>
    <button class="big-btn solo" onclick="playSolo()">
      <span class="bicon">üë§</span> Play Solo (1 screen)
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  SCREEN 2: CREATE ROOM          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="createScreen">
  <div class="wait-card">
    <div style="font-family:'Fredoka One',cursive;color:var(--p1);font-size:1.5rem">üéÆ Your Room</div>
    <p style="color:var(--soft);font-weight:600;font-size:0.9rem">Share this code with your friend!</p>
    <div class="room-code-display" id="roomCodeDisplay">----</div>
    <button class="copy-btn" onclick="copyCode()">üìã Copy Code</button>
    <input class="name-input-lg" id="createName" placeholder="Your name (Player 1)" value="Player 1">
    <div class="wait-msg">
      Waiting for your friend to join<span class="wait-dots"><span>.</span><span>.</span><span>.</span></span>
    </div>
    <p style="color:var(--soft);font-size:0.78rem;font-weight:600;text-align:center">üöÄ Game starts automatically when they join!</p>
    <button class="ctrl secondary" style="width:100%;margin-top:0.3rem" onclick="goHome()">‚Üê Back</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  SCREEN 3: JOIN ROOM            -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="joinScreen">
  <div class="join-card">
    <h2>üîó Join Room</h2>
    <p>Ask Player 1 for their room code!</p>
    <input class="code-input" id="joinCodeIn" placeholder="CODE" maxlength="6" oninput="this.value=this.value.toUpperCase()">
    <input class="name-input-lg" id="joinName" placeholder="Your name (Player 2)" value="Player 2">
    <button class="big-btn join" style="width:100%" onclick="joinRoom()">
      <span class="bicon">üöÄ</span> Join!
    </button>
    <div id="joinMsg" style="color:#b91c1c;font-weight:700;font-size:0.85rem;min-height:1.2rem"></div>
    <button class="ctrl secondary" style="width:100%" onclick="goHome()">‚Üê Back</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  SCREEN 4: GAME                 -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="gameScreen">

  <div class="theme-pill">
    <div id="gThemeName">üëë Princess</div>
    <div class="theme-kw" id="gThemeKw">pink ¬∑ crown ¬∑ elegant ¬∑ royal</div>
  </div>

  <div class="timer-row">
    <span>‚è±</span>
    <div class="timer-track"><div class="timer-fill" id="timerFill" style="width:100%"></div></div>
    <div class="timer-num" id="timerNum">60</div>
  </div>

  <!-- Hint chips -->
  <div class="hints-scroll" id="hintsScroll">
    <!-- filled by JS based on theme -->
  </div>

  <div class="players-area">
    <!-- MY CARD -->
    <div class="pcard me" id="myCard">
      <div class="pcard-header">
        <div class="pname"><span class="dot" style="background:var(--p1)"></span><span id="myNameDisplay">You</span></div>
        <span class="pme-badge">YOU ‚ú®</span>
        <div class="pscore" id="myScore">0 pts</div>
      </div>
      <div class="char-box"><svg id="mySvg" viewBox="0 0 180 310" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="mSkin" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FDDBB4"/><stop offset="100%" stop-color="#F0B88A"/></linearGradient>
          <linearGradient id="mRainbow" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#f87171"/><stop offset="25%" stop-color="#facc15"/><stop offset="50%" stop-color="#4ade80"/><stop offset="75%" stop-color="#60a5fa"/><stop offset="100%" stop-color="#c084fc"/></linearGradient>
          <filter id="mDs"><feDropShadow dx="1" dy="3" stdDeviation="3" flood-opacity="0.12"/></filter>
        </defs>
        <ellipse cx="90" cy="306" rx="44" ry="6" fill="rgba(0,0,0,0.07)"/>
        <rect x="67" y="238" width="20" height="62" rx="10" fill="url(#mSkin)"/>
        <rect x="93" y="238" width="20" height="62" rx="10" fill="url(#mSkin)"/>
        <ellipse id="mSL" cx="77" cy="302" rx="17" ry="8" fill="#E8547A" filter="url(#mDs)"/>
        <ellipse id="mSR" cx="103" cy="302" rx="17" ry="8" fill="#E8547A" filter="url(#mDs)"/>
        <path id="mSkirt" d="M54 176 Q50 200 42 248 Q66 260 90 262 Q114 260 138 248 Q130 200 126 176 Z" fill="#FF85A1" filter="url(#mDs)"/>
        <path d="M66 182 Q63 212 59 240" stroke="rgba(255,255,255,0.3)" stroke-width="3" fill="none" stroke-linecap="round"/>
        <rect id="mTorso" x="58" y="115" width="64" height="68" rx="14" fill="#FFB3C8" filter="url(#mDs)"/>
        <path id="mCollar" d="M80 115 Q90 128 100 115" fill="none" stroke="#FF85A1" stroke-width="4" stroke-linecap="round"/>
        <rect x="38" y="118" width="22" height="56" rx="11" fill="url(#mSkin)"/>
        <rect x="120" y="118" width="22" height="56" rx="11" fill="url(#mSkin)"/>
        <circle cx="49" cy="177" r="11" fill="url(#mSkin)"/>
        <circle cx="131" cy="177" r="11" fill="url(#mSkin)"/>
        <ellipse cx="55" cy="168" rx="5" ry="7" fill="url(#mSkin)"/>
        <ellipse cx="61" cy="166" rx="5" ry="7" fill="url(#mSkin)"/>
        <ellipse cx="67" cy="168" rx="5" ry="7" fill="url(#mSkin)"/>
        <ellipse cx="113" cy="168" rx="5" ry="7" fill="url(#mSkin)"/>
        <ellipse cx="119" cy="166" rx="5" ry="7" fill="url(#mSkin)"/>
        <ellipse cx="125" cy="168" rx="5" ry="7" fill="url(#mSkin)"/>
        <rect x="81" y="103" width="18" height="16" rx="6" fill="url(#mSkin)"/>
        <ellipse id="mHairBack" cx="90" cy="78" rx="44" ry="48" fill="#8B5A2B" filter="url(#mDs)"/>
        <ellipse cx="90" cy="80" rx="38" ry="42" fill="url(#mSkin)" filter="url(#mDs)"/>
        <ellipse cx="52" cy="82" rx="8" ry="10" fill="#F0B88A"/>
        <ellipse cx="52" cy="82" rx="4" ry="6" fill="#E0A070"/>
        <ellipse cx="128" cy="82" rx="8" ry="10" fill="#F0B88A"/>
        <ellipse cx="128" cy="82" rx="4" ry="6" fill="#E0A070"/>
        <ellipse id="mHairFront" cx="90" cy="56" rx="42" ry="24" fill="#8B5A2B"/>
        <path id="mHairLine" d="M52 64 Q72 46 90 44 Q108 46 128 64" fill="#8B5A2B"/>
        <path d="M68 64 Q76 59 82 62" stroke="#5C3317" stroke-width="2" fill="none" stroke-linecap="round"/>
        <path d="M98 62 Q104 59 112 64" stroke="#5C3317" stroke-width="2" fill="none" stroke-linecap="round"/>
        <ellipse cx="75" cy="78" rx="9" ry="10" fill="white"/>
        <ellipse cx="105" cy="78" rx="9" ry="10" fill="white"/>
        <ellipse cx="75" cy="79" rx="6" ry="7" fill="#5B3A8C"/>
        <ellipse cx="105" cy="79" rx="6" ry="7" fill="#5B3A8C"/>
        <ellipse cx="75" cy="80" rx="3.5" ry="4.5" fill="#1a0010"/>
        <ellipse cx="105" cy="80" rx="3.5" ry="4.5" fill="#1a0010"/>
        <ellipse cx="77" cy="76" rx="2" ry="2.5" fill="white" opacity="0.9"/>
        <ellipse cx="107" cy="76" rx="2" ry="2.5" fill="white" opacity="0.9"/>
        <path d="M66 71 Q71 67 75 70" stroke="#2C1810" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        <path d="M75 69 Q79 66 83 70" stroke="#2C1810" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        <path d="M97 70 Q101 66 105 69" stroke="#2C1810" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        <path d="M105 70 Q109 67 114 71" stroke="#2C1810" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        <path d="M86 91 Q90 96 94 91" stroke="#C8845A" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        <ellipse id="mCkL" cx="62" cy="88" rx="12" ry="9" fill="rgba(255,133,161,0.25)"/>
        <ellipse id="mCkR" cx="118" cy="88" rx="12" ry="9" fill="rgba(255,133,161,0.25)"/>
        <path id="mLip" d="M80 100 Q90 96 100 100 Q90 108 80 100" fill="rgba(232,84,122,0.3)" stroke="#E8547A" stroke-width="1.8" stroke-linecap="round"/>
        <g id="mHE"></g><g id="mAC"></g><g id="mHA"></g>
      </svg></div>
      <div class="ptags" id="myTags"></div>
      <div class="my-input-area">
        <div class="in-row">
          <input class="pin" id="myIn" placeholder="pink heels, crown, 2 braids‚Ä¶" onkeydown="if(event.key==='Enter')applyMy()">
          <button class="pgo" onclick="applyMy()">‚ú®</button>
        </div>
        <div class="pfb" id="myFb"></div>
      </div>
    </div>

    <!-- THEM CARD -->
    <div class="pcard them" id="themCard">
      <div class="pcard-header">
        <div class="pname"><span class="dot" style="background:var(--p2)"></span><span id="themNameDisplay">Waiting‚Ä¶</span></div>
        <span class="pthem-badge">RIVAL üëÄ</span>
        <div class="pscore" id="themScore">0 pts</div>
      </div>
      <div class="char-box"><svg id="themSvg" viewBox="0 0 180 310" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="tSkin" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FDDBB4"/><stop offset="100%" stop-color="#F0B88A"/></linearGradient>
          <linearGradient id="tRainbow" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#f87171"/><stop offset="25%" stop-color="#facc15"/><stop offset="50%" stop-color="#4ade80"/><stop offset="75%" stop-color="#60a5fa"/><stop offset="100%" stop-color="#c084fc"/></linearGradient>
          <filter id="tDs"><feDropShadow dx="1" dy="3" stdDeviation="3" flood-opacity="0.12"/></filter>
        </defs>
        <ellipse cx="90" cy="306" rx="44" ry="6" fill="rgba(0,0,0,0.07)"/>
        <rect x="67" y="238" width="20" height="62" rx="10" fill="url(#tSkin)"/>
        <rect x="93" y="238" width="20" height="62" rx="10" fill="url(#tSkin)"/>
        <ellipse id="tSL" cx="77" cy="302" rx="17" ry="8" fill="#E8547A" filter="url(#tDs)"/>
        <ellipse id="tSR" cx="103" cy="302" rx="17" ry="8" fill="#E8547A" filter="url(#tDs)"/>
        <path id="tSkirt" d="M54 176 Q50 200 42 248 Q66 260 90 262 Q114 260 138 248 Q130 200 126 176 Z" fill="#818cf8" filter="url(#tDs)"/>
        <path d="M66 182 Q63 212 59 240" stroke="rgba(255,255,255,0.3)" stroke-width="3" fill="none" stroke-linecap="round"/>
        <rect id="tTorso" x="58" y="115" width="64" height="68" rx="14" fill="#a5b4fc" filter="url(#tDs)"/>
        <path id="tCollar" d="M80 115 Q90 128 100 115" fill="none" stroke="#818cf8" stroke-width="4" stroke-linecap="round"/>
        <rect x="38" y="118" width="22" height="56" rx="11" fill="url(#tSkin)"/>
        <rect x="120" y="118" width="22" height="56" rx="11" fill="url(#tSkin)"/>
        <circle cx="49" cy="177" r="11" fill="url(#tSkin)"/>
        <circle cx="131" cy="177" r="11" fill="url(#tSkin)"/>
        <ellipse cx="55" cy="168" rx="5" ry="7" fill="url(#tSkin)"/>
        <ellipse cx="61" cy="166" rx="5" ry="7" fill="url(#tSkin)"/>
        <ellipse cx="67" cy="168" rx="5" ry="7" fill="url(#tSkin)"/>
        <ellipse cx="113" cy="168" rx="5" ry="7" fill="url(#tSkin)"/>
        <ellipse cx="119" cy="166" rx="5" ry="7" fill="url(#tSkin)"/>
        <ellipse cx="125" cy="168" rx="5" ry="7" fill="url(#tSkin)"/>
        <rect x="81" y="103" width="18" height="16" rx="6" fill="url(#tSkin)"/>
        <ellipse id="tHairBack" cx="90" cy="78" rx="44" ry="48" fill="#8B5A2B" filter="url(#tDs)"/>
        <ellipse cx="90" cy="80" rx="38" ry="42" fill="url(#tSkin)" filter="url(#tDs)"/>
        <ellipse cx="52" cy="82" rx="8" ry="10" fill="#F0B88A"/>
        <ellipse cx="52" cy="82" rx="4" ry="6" fill="#E0A070"/>
        <ellipse cx="128" cy="82" rx="8" ry="10" fill="#F0B88A"/>
        <ellipse cx="128" cy="82" rx="4" ry="6" fill="#E0A070"/>
        <ellipse id="tHairFront" cx="90" cy="56" rx="42" ry="24" fill="#8B5A2B"/>
        <path id="tHairLine" d="M52 64 Q72 46 90 44 Q108 46 128 64" fill="#8B5A2B"/>
        <path d="M68 64 Q76 59 82 62" stroke="#5C3317" stroke-width="2" fill="none" stroke-linecap="round"/>
        <path d="M98 62 Q104 59 112 64" stroke="#5C3317" stroke-width="2" fill="none" stroke-linecap="round"/>
        <ellipse cx="75" cy="78" rx="9" ry="10" fill="white"/>
        <ellipse cx="105" cy="78" rx="9" ry="10" fill="white"/>
        <ellipse cx="75" cy="79" rx="6" ry="7" fill="#5B3A8C"/>
        <ellipse cx="105" cy="79" rx="6" ry="7" fill="#5B3A8C"/>
        <ellipse cx="75" cy="80" rx="3.5" ry="4.5" fill="#1a0010"/>
        <ellipse cx="105" cy="80" rx="3.5" ry="4.5" fill="#1a0010"/>
        <ellipse cx="77" cy="76" rx="2" ry="2.5" fill="white" opacity="0.9"/>
        <ellipse cx="107" cy="76" rx="2" ry="2.5" fill="white" opacity="0.9"/>
        <path d="M66 71 Q71 67 75 70" stroke="#2C1810" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        <path d="M75 69 Q79 66 83 70" stroke="#2C1810" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        <path d="M97 70 Q101 66 105 69" stroke="#2C1810" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        <path d="M105 70 Q109 67 114 71" stroke="#2C1810" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        <path d="M86 91 Q90 96 94 91" stroke="#C8845A" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        <ellipse id="tCkL" cx="62" cy="88" rx="12" ry="9" fill="rgba(255,133,161,0.25)"/>
        <ellipse id="tCkR" cx="118" cy="88" rx="12" ry="9" fill="rgba(255,133,161,0.25)"/>
        <path id="tLip" d="M80 100 Q90 96 100 100 Q90 108 80 100" fill="rgba(232,84,122,0.3)" stroke="#E8547A" stroke-width="1.8" stroke-linecap="round"/>
        <g id="tHE"></g><g id="tAC"></g><g id="tHA"></g>
      </svg></div>
      <div class="ptags" id="themTags"></div>
      <div class="waiting-them" id="themWaiting">üëÄ Watching their moves‚Ä¶</div>
    </div>
  </div>

  <!-- Hint chips -->
  <div class="hints-scroll" id="hintsRow">
    <span class="hc" onclick="typeHint('pink dress')">pink dress</span>
    <span class="hc" onclick="typeHint('crown')">crown</span>
    <span class="hc" onclick="typeHint('long hair')">long hair</span>
    <span class="hc" onclick="typeHint('hair blonde')">hair blonde</span>
    <span class="hc" onclick="typeHint('2 braids')">2 braids</span>
    <span class="hc" onclick="typeHint('tiara')">tiara</span>
    <span class="hc" onclick="typeHint('heels')">heels</span>
    <span class="hc" onclick="typeHint('tutu')">tutu</span>
    <span class="hc" onclick="typeHint('necklace')">necklace</span>
    <span class="hc" onclick="typeHint('wings')">wings</span>
    <span class="hc" onclick="typeHint('bow')">bow</span>
    <span class="hc" onclick="typeHint('earrings')">earrings</span>
    <span class="hc" onclick="typeHint('wand')">wand</span>
    <span class="hc" onclick="typeHint('bun')">bun</span>
    <span class="hc" onclick="typeHint('curly')">curly</span>
    <span class="hc" onclick="typeHint('ponytail')">ponytail</span>
    <span class="hc" onclick="typeHint('boots')">boots</span>
    <span class="hc" onclick="typeHint('scarf')">scarf</span>
    <span class="hc" onclick="typeHint('blue skirt')">blue skirt</span>
    <span class="hc" onclick="typeHint('purple dress')">purple dress</span>
    <span class="hc" onclick="typeHint('hair rainbow')">hair rainbow</span>
    <span class="hc" onclick="typeHint('witch hat')">witch hat</span>
    <span class="hc" onclick="typeHint('cape')">cape</span>
  </div>

  <div class="bottom-ctrls">
    <button class="ctrl primary" onclick="judgeNow()">üèÜ Judge!</button>
    <button class="ctrl secondary" onclick="resetMe()">üîÑ Reset</button>
    <button class="ctrl secondary" onclick="newThemeHost()">üé≤ Theme</button>
  </div>

</div><!-- end gameScreen -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MULTIPLAYER via PeerJS (real cross-device P2P)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let myRole = null; // 'host' or 'guest'
let roomCode = '';
let myName = 'Player 1';
let themName = 'Player 2';
let currentThemeIdx = 0;
let timerInterval = null;
let timeLeft = 180;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THEMES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const THEMES = [
  {name:'üëë Princess',emoji:'üëë',kw:['pink','crown','elegant','royal','sparkle'],
   good:['crown','tiara','pink dress','white dress','heels','glass slippers','necklace','long hair','blonde hair','curly','earrings','tutu']},
  {name:'üßú Mermaid',emoji:'üßú',kw:['blue','green','ocean','waves','aqua','sea'],
   good:['blue dress','green skirt','waves','long hair','teal','necklace','earrings','scarf','hair blue','hair green']},
  {name:'üßö Fairy',emoji:'üßö',kw:['wings','sparkle','tiny','magical','pastel'],
   good:['wings','fairy wings','tiara','flower','bow','pink dress','short hair','wand','earrings','tutu']},
  {name:'üîÆ Witch',emoji:'üîÆ',kw:['black','purple','magic','dark','mysterious'],
   good:['witch hat','black dress','purple skirt','boots','wand','cape','hair black','hair purple','glasses']},
  {name:'üå∏ Mulan',emoji:'üå∏',kw:['red','gold','silk','brave','warrior'],
   good:['red dress','red skirt','hair black','bun','braid crown','flower','necklace','red heels']},
  {name:'‚ùÑÔ∏è Elsa',emoji:'‚ùÑÔ∏è',kw:['blue','ice','frozen','silver','snow'],
   good:['blue dress','white dress','hair blonde','long hair','braid','silver','scarf','necklace']},
  {name:'üè´ School Glam',emoji:'üè´',kw:['chic','cute','fun','colourful','trendy'],
   good:['ponytail','bow','sneakers','blue skirt','pink top','glasses','earrings','short hair']},
  {name:'üåô Night Queen',emoji:'üåô',kw:['dark','silver','stars','elegant','midnight'],
   good:['black dress','crown','earrings','necklace','heels','stars','hair black','long hair']},
  {name:'üå∫ Garden Party',emoji:'üå∫',kw:['floral','pastel','sweet','gentle','spring'],
   good:['pink dress','flower','bow','sandals','pigtails','curly','earrings','white dress']},
  {name:'üéÉ Halloween',emoji:'üéÉ',kw:['spooky','dark','orange','black','witch'],
   good:['witch hat','black dress','cape','boots','hair black','glasses','wand','purple skirt']},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COLORS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CMAP={pink:'#FF85A1','hot pink':'#FF1493',red:'#dc2626',orange:'#f97316',yellow:'#fbbf24',gold:'#FFD700',green:'#22c55e',mint:'#6ee7b7',teal:'#14b8a6',blue:'#3b82f6','light blue':'#7dd3fc',navy:'#1e3a5f',purple:'#9333ea',lavender:'#c4b5fd',white:'#FFFFFF',black:'#1c1c1c',brown:'#8B5A2B',blonde:'#F5DEB3','golden blonde':'#F0C040',gray:'#94a3b8',silver:'#d1d5db',coral:'#fb7185',peach:'#fca5a5',turquoise:'#2dd4bf',magenta:'#e879f9',rainbow:'rainbow',icy:'#bae6fd',ice:'#bae6fd',scarlet:'#dc2626','rose gold':'#e8a598'};
const getC=w=>CMAP[w.toLowerCase().trim()]||null;
function findC(words){for(let i=0;i<words.length-1;i++){const c=getC(words[i]+' '+words[i+1]);if(c)return{c,at:i,len:2};}for(let i=0;i<words.length;i++){const c=getC(words[i]);if(c)return{c,at:i,len:1};}return null;}
function shade(hex,n){if(!hex||hex==='rainbow'||hex.startsWith('rgba')||hex.startsWith('url'))return hex;let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);r=Math.max(0,Math.min(255,r+n));g=Math.max(0,Math.min(255,g+n));b=Math.max(0,Math.min(255,b+n));return'#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE per character
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function freshState(prefix){return{prefix,hairStyle:'default',hairColor:'#8B5A2B',topColor:prefix==='m'?'#FFB3C8':'#a5b4fc',skirtColor:prefix==='m'?'#FF85A1':'#818cf8',shoeColor:'#E8547A',accs:{},items:[]};}
let myState=freshState('m'), themState=freshState('t');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KEYWORDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getKW(st){return{
  'long hair':()=>doHair(st,'long'),'short hair':()=>doHair(st,'short'),'2 braids':()=>doHair(st,'braids'),'two braids':()=>doHair(st,'braids'),'braids':()=>doHair(st,'braids'),'braid':()=>doHair(st,'braids'),'braid crown':()=>doHair(st,'braidcrown'),'ponytail':()=>doHair(st,'ponytail'),'pigtails':()=>doHair(st,'pigtails'),'curly':()=>doHair(st,'curly'),'curly hair':()=>doHair(st,'curly'),'bun':()=>doHair(st,'bun'),'waves':()=>doHair(st,'waves'),'wavy':()=>doHair(st,'waves'),'pixie':()=>doHair(st,'pixie'),
  'dress':w=>doTop(st,findC(w)?.c||st.topColor),'blouse':w=>doTop(st,findC(w)?.c||st.topColor),'shirt':w=>doTop(st,findC(w)?.c||st.topColor),'top':w=>doTop(st,findC(w)?.c||st.topColor),'sweater':w=>doTop(st,findC(w)?.c||st.topColor),'kimono':w=>doTop(st,findC(w)?.c||'#dc2626'),
  'skirt':w=>doSkirt(st,findC(w)?.c||st.skirtColor,'default'),'tutu':w=>doSkirt(st,findC(w)?.c||st.skirtColor,'tutu'),'long skirt':w=>doSkirt(st,findC(w)?.c||st.skirtColor,'long'),
  'heels':w=>doShoes(st,findC(w)?.c||'#E8547A','heels'),'boots':w=>doShoes(st,findC(w)?.c||'#5C3317','boots'),'sneakers':w=>doShoes(st,findC(w)?.c||'#FFFFFF','sneakers'),'sandals':w=>doShoes(st,findC(w)?.c||'#DEB887','sandals'),'flats':w=>doShoes(st,findC(w)?.c||'#E8547A','flats'),'glass slippers':()=>doShoes(st,'rgba(180,220,255,0.85)','glass'),'slippers':()=>doShoes(st,'rgba(180,220,255,0.85)','glass'),
  'crown':()=>doAcc(st,'crown'),'tiara':()=>doAcc(st,'tiara'),'flower':()=>doAcc(st,'flower'),'bow':()=>doAcc(st,'bow'),'stars':()=>doAcc(st,'stars'),'star clips':()=>doAcc(st,'stars'),'necklace':()=>doAcc(st,'necklace'),'earrings':()=>doAcc(st,'earrings'),'glasses':()=>doAcc(st,'glasses'),'wings':()=>doAcc(st,'wings'),'fairy wings':()=>doAcc(st,'wings'),'wand':()=>doAcc(st,'wand'),'witch hat':()=>doAcc(st,'witchhat'),'hat':()=>doAcc(st,'hat'),'scarf':()=>doAcc(st,'scarf'),'cape':()=>doAcc(st,'cape'),'hearts':()=>doAcc(st,'hearts'),'heart':()=>doAcc(st,'hearts'),
  'smile':()=>{},'wink':()=>{},'blush':()=>doBlush(st),
};}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PARSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseAndApply(st,raw){
  const lower=raw.toLowerCase().trim(), words=lower.split(/\s+/);
  const KW=getKW(st);
  if(words[0]==='hair'&&words.length>1){const c=getC(words.slice(1).join(' '))||getC(words[1]);if(c){doHairColor(st,c);return true;}}
  for(let len=4;len>=1;len--){for(let i=0;i<=words.length-len;i++){const ph=words.slice(i,i+len).join(' ');if(KW[ph]){KW[ph](words);return true;}}}
  const cf=findC(words);if(cf){const rest=[...words.slice(0,cf.at),...words.slice(cf.at+cf.len)];for(let len=3;len>=1;len--){for(let i=0;i<=rest.length-len;i++){const ph=rest.slice(i,i+len).join(' ');if(KW[ph]){KW[ph](words);return true;}}}}
  return false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const p=st=>st.prefix;
const svgN=st=>document.getElementById(st.prefix==='m'?'mySvg':'themSvg');
function fillC(c,pf){return c==='rainbow'?`url(#${pf}Rainbow)`:c;}
function mkEl(parent,tag,attrs){const el=document.createElementNS('http://www.w3.org/2000/svg',tag);for(const[k,v] of Object.entries(attrs))el.setAttribute(k,v);parent.appendChild(el);return el;}
function g(id){return document.getElementById(id);}

function doHair(st,style){st.hairStyle=style;renderHair(st);}
function doHairColor(st,c){st.hairColor=c;renderHair(st);}

function renderHair(st){
  const pf=p(st),c=st.hairColor,f=fillC(c,pf);
  const hb=g(`${pf}HairBack`),hf=g(`${pf}HairFront`),hl=g(`${pf}HairLine`),he=g(`${pf}HE`);
  hb.setAttribute('fill',f);hf.setAttribute('fill',f);hl.setAttribute('fill',f);
  he.innerHTML='';
  const mk=(tag,attrs)=>mkEl(he,tag,attrs);
  const style=st.hairStyle;
  const sh=shade(c,-30);

  if(style==='long'){hb.setAttribute('rx','44');hb.setAttribute('ry','72');hb.setAttribute('cy','84');hf.setAttribute('cx','90');hf.setAttribute('cy','54');hf.setAttribute('rx','42');hf.setAttribute('ry','22');hl.setAttribute('d','M52 62 Q72 44 90 42 Q108 44 128 62');}
  else if(style==='short'){hb.setAttribute('rx','44');hb.setAttribute('ry','40');hb.setAttribute('cy','76');hf.setAttribute('cx','90');hf.setAttribute('cy','54');hf.setAttribute('rx','40');hf.setAttribute('ry','18');hl.setAttribute('d','M54 62 Q72 46 90 44 Q108 46 126 62');}
  else if(style==='braids'){hb.setAttribute('rx','44');hb.setAttribute('ry','48');hb.setAttribute('cy','78');hf.setAttribute('cx','90');hf.setAttribute('cy','56');hf.setAttribute('rx','42');hf.setAttribute('ry','24');hl.setAttribute('d','M52 64 Q72 46 90 44 Q108 46 128 64');[[68,110],[112,110]].forEach(([bx,by])=>{for(let i=0;i<7;i++)mk('ellipse',{cx:bx,cy:by+i*14,rx:'8',ry:'7',fill:f,stroke:sh,'stroke-width':'1.5'});});}
  else if(style==='braidcrown'){hb.setAttribute('rx','44');hb.setAttribute('ry','48');hb.setAttribute('cy','78');hf.setAttribute('cx','90');hf.setAttribute('cy','56');hf.setAttribute('rx','42');hf.setAttribute('ry','24');hl.setAttribute('d','M52 64 Q72 46 90 44 Q108 46 128 64');mk('path',{d:'M52 64 Q72 38 90 34 Q108 38 128 64',fill:'none',stroke:f,'stroke-width':'14','stroke-linecap':'round'});mk('path',{d:'M52 64 Q72 38 90 34 Q108 38 128 64',fill:'none',stroke:sh,'stroke-width':'3','stroke-linecap':'round','stroke-dasharray':'5,7'});}
  else if(style==='ponytail'){hb.setAttribute('rx','44');hb.setAttribute('ry','48');hb.setAttribute('cy','78');hf.setAttribute('cx','90');hf.setAttribute('cy','56');hf.setAttribute('rx','42');hf.setAttribute('ry','22');hl.setAttribute('d','M52 62 Q72 44 90 42 Q108 44 128 62');mk('path',{d:'M118 60 Q145 76 140 126 Q135 158 126 172 Q116 162 120 130 Q128 98 108 68 Z',fill:f});mk('ellipse',{cx:'124',cy:'62',rx:'7',ry:'7',fill:sh});}
  else if(style==='pigtails'){hb.setAttribute('rx','44');hb.setAttribute('ry','48');hb.setAttribute('cy','78');hf.setAttribute('cx','90');hf.setAttribute('cy','56');hf.setAttribute('rx','42');hf.setAttribute('ry','22');hl.setAttribute('d','M52 62 Q72 44 90 42 Q108 44 128 62');mk('path',{d:'M52 74 Q28 90 26 136 Q24 166 33 180 Q45 170 42 140 Q46 108 60 84 Z',fill:f});mk('path',{d:'M128 74 Q152 90 154 136 Q156 166 147 180 Q135 170 138 140 Q134 108 120 84 Z',fill:f});}
  else if(style==='curly'){hb.setAttribute('rx','50');hb.setAttribute('ry','56');hb.setAttribute('cy','80');hf.setAttribute('cx','90');hf.setAttribute('cy','56');hf.setAttribute('rx','48');hf.setAttribute('ry','26');hl.setAttribute('d','M48 66 Q70 46 90 44 Q110 46 132 66');[[52,92],[64,112],[78,122],[92,126],[106,122],[120,112],[128,92]].forEach(([cx,cy])=>mk('circle',{cx,cy,r:'12',fill:f}));}
  else if(style==='bun'){hb.setAttribute('rx','44');hb.setAttribute('ry','46');hb.setAttribute('cy','80');hf.setAttribute('cx','90');hf.setAttribute('cy','58');hf.setAttribute('rx','42');hf.setAttribute('ry','20');hl.setAttribute('d','M52 64 Q72 48 90 46 Q108 48 128 64');mk('circle',{cx:'90',cy:'42',r:'20',fill:f,stroke:sh,'stroke-width':'2.5'});mk('path',{d:'M82 40 Q90 33 98 40 Q96 46 90 48 Q84 46 82 40',fill:'none',stroke:sh,'stroke-width':'1.5'});}
  else if(style==='waves'){hb.setAttribute('rx','44');hb.setAttribute('ry','68');hb.setAttribute('cy','82');hf.setAttribute('cx','90');hf.setAttribute('cy','56');hf.setAttribute('rx','42');hf.setAttribute('ry','24');hl.setAttribute('d','M52 64 Q72 46 90 44 Q108 46 128 64');[[48,88],[132,88]].forEach(([sx,sy],i)=>{const ox=i===0?12:-12;mk('path',{d:`M${sx} ${sy} Q${sx+ox} ${sy+16} ${sx} ${sy+32} Q${sx-ox} ${sy+48} ${sx} ${sy+64} Q${sx+ox} ${sy+80} ${sx} ${sy+96}`,stroke:f,'stroke-width':'16',fill:'none','stroke-linecap':'round'});});}
  else if(style==='pixie'){hb.setAttribute('rx','44');hb.setAttribute('ry','36');hb.setAttribute('cy','76');hf.setAttribute('cx','90');hf.setAttribute('cy','54');hf.setAttribute('rx','42');hf.setAttribute('ry','18');hl.setAttribute('d','M54 60 Q72 46 90 44 Q108 46 126 60');}
  else{hb.setAttribute('rx','44');hb.setAttribute('ry','48');hb.setAttribute('cy','78');hf.setAttribute('cx','90');hf.setAttribute('cy','56');hf.setAttribute('rx','42');hf.setAttribute('ry','24');hl.setAttribute('d','M52 64 Q72 46 90 44 Q108 46 128 64');}
}

function doTop(st,c){st.topColor=c;const pf=p(st),f=fillC(c,pf);g(`${pf}Torso`).setAttribute('fill',f);g(`${pf}Collar`).setAttribute('stroke',shade(c,-20));}
function doSkirt(st,c,style){st.skirtColor=c;const pf=p(st),f=fillC(c,pf),sk=g(`${pf}Skirt`);sk.setAttribute('fill',f);if(style==='tutu')sk.setAttribute('d','M46 176 Q40 198 30 250 Q62 268 90 270 Q118 268 150 250 Q140 198 134 176 Z');else if(style==='long')sk.setAttribute('d','M54 176 Q48 210 40 270 Q62 284 90 286 Q118 284 140 270 Q132 210 126 176 Z');else sk.setAttribute('d','M54 176 Q50 200 42 248 Q66 260 90 262 Q114 260 138 248 Q130 200 126 176 Z');}
function doShoes(st,c,style){st.shoeColor=c;const pf=p(st),sl=g(`${pf}SL`),sr=g(`${pf}SR`);sl.setAttribute('fill',c);sr.setAttribute('fill',c);if(style==='boots'){sl.setAttribute('ry','11');sl.setAttribute('cy','298');sr.setAttribute('ry','11');sr.setAttribute('cy','298');}else if(style==='heels'){sl.setAttribute('ry','7');sl.setAttribute('cy','302');sr.setAttribute('ry','7');sr.setAttribute('cy','302');}else{sl.setAttribute('ry','8');sl.setAttribute('cy','302');sr.setAttribute('ry','8');sr.setAttribute('cy','302');}}
function doBlush(st){const pf=p(st);g(`${pf}CkL`).setAttribute('fill','rgba(255,100,140,0.5)');g(`${pf}CkR`).setAttribute('fill','rgba(255,100,140,0.5)');}

function doAcc(st,type){
  if(st.accs[type])return;st.accs[type]=true;
  const pf=p(st),ha=g(`${pf}HA`),ac=g(`${pf}AC`);
  const mk=(parent,tag,attrs)=>mkEl(parent,tag,attrs);
  if(type==='crown'){mk(ha,'path',{d:'M58 42 L65 24 L75 38 L90 18 L105 38 L115 24 L122 42 Z',fill:'#FFD700',stroke:'#F59E0B','stroke-width':'2'});['#FF85A1','#9333ea','#3b82f6'].forEach((c,i)=>mk(ha,'circle',{cx:68+i*16,cy:34,r:'3.5',fill:c}));}
  else if(type==='tiara'){mk(ha,'path',{d:'M54 52 Q64 36 78 44 Q90 30 102 44 Q116 36 126 52',stroke:'#FFD700','stroke-width':'4',fill:'none','stroke-linecap':'round'});mk(ha,'circle',{cx:'90',cy:'32',r:'5',fill:'#FF85A1'});}
  else if(type==='flower'){const cx=124,cy=48;['#FF85A1','#FFB3C8','#FF6B9D','#FFD6E0','#FF85A1'].forEach((c,i)=>{const a=i*72*Math.PI/180;mk(ha,'ellipse',{cx:cx+Math.cos(a)*8,cy:cy+Math.sin(a)*8,rx:'6',ry:'4',fill:c,transform:`rotate(${i*72},${cx},${cy})`});});mk(ha,'circle',{cx:cx,cy:cy,r:'5',fill:'#FFD700'});}
  else if(type==='bow'){mk(ha,'path',{d:'M70 38 Q56 28 58 40 Q60 52 70 46 Q80 52 82 40 Q84 28 70 38 Z',fill:'#FF85A1',stroke:'#E8547A','stroke-width':'1.5'});mk(ha,'circle',{cx:'70',cy:'42',r:'4',fill:'#E8547A'});}
  else if(type==='stars'){[[60,38],[122,42]].forEach(([cx,cy])=>{const pts=[];for(let i=0;i<10;i++){const a=(i*36-90)*Math.PI/180,r=i%2===0?9:4.5;pts.push(`${cx+r*Math.cos(a)},${cy+r*Math.sin(a)}`);}mk(ha,'polygon',{points:pts.join(' '),fill:'#FFD700',stroke:'#F59E0B','stroke-width':'1'});});}
  else if(type==='necklace'){mk(ac,'path',{d:'M60 120 Q90 132 120 120',stroke:'#FFD700','stroke-width':'2.5',fill:'none','stroke-linecap':'round'});mk(ac,'polygon',{points:'90,128 94,136 90,144 86,136',fill:'#FF85A1',stroke:'#E8547A','stroke-width':'1'});}
  else if(type==='earrings'){[52,128].forEach(cx=>{mk(ac,'circle',{cx,cy:'88',r:'4',fill:'#FFD700'});mk(ac,'circle',{cx,cy:'98',r:'5',fill:'#FF85A1'});});}
  else if(type==='glasses'){mk(ac,'path',{d:'M60 78 Q68 71 78 78 Q82 82 86 78 Q94 71 104 78 Q106 84 100 87 Q94 90 86 87 Q82 89 78 87 Q68 90 62 87 Q58 84 60 78 Z',fill:'none',stroke:'#9333ea','stroke-width':'2.5'});mk(ac,'line',{x1:'78',y1:'80',x2:'86',y2:'80',stroke:'#9333ea','stroke-width':'2'});}
  else if(type==='wings'){mk(ac,'path',{d:'M46 132 Q16 108 14 148 Q12 188 44 176 Q38 158 46 142 Z',fill:'rgba(200,230,255,0.7)',stroke:'#c4b5fd','stroke-width':'2'});mk(ac,'path',{d:'M46 150 Q18 142 18 168 Q18 194 46 186 Z',fill:'rgba(200,230,255,0.5)',stroke:'#c4b5fd','stroke-width':'1.5'});mk(ac,'path',{d:'M134 132 Q164 108 166 148 Q168 188 136 176 Q142 158 134 142 Z',fill:'rgba(200,230,255,0.7)',stroke:'#c4b5fd','stroke-width':'2'});mk(ac,'path',{d:'M134 150 Q162 142 162 168 Q162 194 134 186 Z',fill:'rgba(200,230,255,0.5)',stroke:'#c4b5fd','stroke-width':'1.5'});}
  else if(type==='wand'){mk(ac,'line',{x1:'132',y1:'170',x2:'150',y2:'122',stroke:'#8B5A2B','stroke-width':'4','stroke-linecap':'round'});const pts=[];for(let i=0;i<10;i++){const a=(i*36-90)*Math.PI/180,r=i%2===0?11:5;pts.push(`${150+r*Math.cos(a)},${118+r*Math.sin(a)}`);}mk(ac,'polygon',{points:pts.join(' '),fill:'#FFD700'});}
  else if(type==='witchhat'){mk(ha,'ellipse',{cx:'90',cy:'44',rx:'44',ry:'10',fill:'#1c1c1c'});mk(ha,'path',{d:'M62 44 Q76 24 90 4 Q104 24 118 44 Z',fill:'#2d1b4e'});mk(ha,'rect',{x:'62',y:'36',width:'56',height:'8',rx:'2',fill:'#c4b5fd'});}
  else if(type==='hat'){mk(ha,'ellipse',{cx:'90',cy:'42',rx:'46',ry:'10',fill:'#8B5A2B'});mk(ha,'rect',{x:'60',y:'10',width:'60',height:'34',rx:'8',fill:'#6B3A1F'});mk(ha,'rect',{x:'60',y:'38',width:'60',height:'8',fill:'#FF85A1'});}
  else if(type==='scarf'){mk(ac,'path',{d:'M62 108 Q90 120 118 108 Q122 118 118 124 Q90 136 62 124 Q58 118 62 108 Z',fill:'#c4b5fd',stroke:'#9333ea','stroke-width':'1.5'});mk(ac,'path',{d:'M72 124 Q70 148 66 162',stroke:'#c4b5fd','stroke-width':'10',fill:'none','stroke-linecap':'round'});}
  else if(type==='cape'){mk(ac,'path',{d:'M58 120 Q20 160 26 230 Q58 250 90 252 Q122 250 154 230 Q160 160 122 120 Z',fill:'rgba(147,51,234,0.7)',stroke:'#7c3aed','stroke-width':'2'});}
  else if(type==='hearts'){[[56,42],[124,46]].forEach(([cx,cy])=>mk(ha,'path',{d:`M${cx} ${cy+4} Q${cx-7} ${cy-4} ${cx} ${cy+1} Q${cx+7} ${cy-4} ${cx} ${cy+4} Z`,fill:'#FF85A1'}));}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCORING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcScore(st){
  const theme=THEMES[currentThemeIdx];
  let s=0;
  st.items.forEach(item=>{
    theme.good.forEach(gi=>{if(item.includes(gi.split(' ')[0])||gi.includes(item.split(' ')[0]))s+=10;});
  });
  return Math.min(s,100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NETWORKING via PeerJS (real cross-device P2P)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let peer = null;
let conn = null;

function setStatus(ok, msg){
  const el = g('connStatus');
  el.textContent = msg;
  el.className = 'conn-status ' + (ok ? 'online' : 'offline');
}

function send(type, data={}){
  if(conn && conn.open){
    conn.send({type, from:myRole, ...data});
  }
}

function setupConn(c){
  conn = c;
  conn.on('open', ()=>{
    setStatus(true, 'üü¢ Connected!');
  });
  conn.on('data', d => handleMsg(d));
  conn.on('close', ()=>{
    setStatus(false, 'üî¥ Disconnected');
  });
  conn.on('error', e=>{
    setStatus(false, 'üî¥ Error');
    console.error(e);
  });
}

function initHost(code){
  if(peer){ peer.destroy(); }
  // Use the room code as the peer ID so guest can find us
  const peerId = 'stylebattle-' + code;
  peer = new Peer(peerId);
  peer.on('open', ()=>{
    setStatus(false, '‚è≥ Waiting‚Ä¶');
  });
  peer.on('connection', c=>{
    setupConn(c);
    // connection established ‚Äî handleMsg will take it from here
  });
  peer.on('error', e=>{
    // ID taken ‚Äî try with random suffix
    if(e.type==='unavailable-id'){
      const peerId2 = 'stylebattle-' + code + '-' + Math.random().toString(36).substring(2,5);
      peer = new Peer(peerId2);
      roomCode = peerId2.replace('stylebattle-','');
      g('roomCodeDisplay').textContent = roomCode;
      peer.on('open', ()=>setStatus(false,'‚è≥ Waiting‚Ä¶'));
      peer.on('connection', c=>{ setupConn(c); });
    } else {
      setStatus(false, 'üî¥ ' + e.type);
    }
  });
}

function initGuest(code){
  if(peer){ peer.destroy(); }
  peer = new Peer();
  peer.on('open', ()=>{
    setStatus(false, 'üîó Connecting‚Ä¶');
    const c = peer.connect('stylebattle-' + code, {reliable:true});
    setupConn(c);
  });
  peer.on('error', e=>{
    setStatus(false, 'üî¥ Cannot connect ‚Äî check code!');
    g('joinMsg').textContent = '‚ùå Could not connect. Is the code correct?';
    g('joinMsg').style.color = '#b91c1c';
  });
}

function handleMsg(msg){
  if(msg.from===myRole)return; // ignore own messages

  if(msg.type==='join'){
    themName=msg.name;
    g('themNameDisplay').textContent=themName;
    if(myRole==='host'){
      // Auto-start immediately ‚Äî both enter game at same time!
      myName=g('createName').value||'Player 1';
      g('myNameDisplay').textContent=myName;
      currentThemeIdx=Math.floor(Math.random()*THEMES.length);
      send('welcome',{name:myName,themeIdx:currentThemeIdx});
      applyThemeUI();
      showScreen('gameScreen');
      showPhaseAnim();
      startTimer();
    }
  }
  if(msg.type==='welcome'){
    themName=msg.name;
    g('themNameDisplay').textContent=themName;
    currentThemeIdx=msg.themeIdx;
    setStatus(true,'üü¢ Connected!');
    applyThemeUI();
    showScreen('gameScreen');
    showPhaseAnim();
    startTimer();
  }
  if(msg.type==='start'){
    currentThemeIdx=msg.themeIdx;
    applyThemeUI();
    showScreen('gameScreen');
    showPhaseAnim();
    startTimer();
  }
  if(msg.type==='item'){
    // opponent applied something ‚Äî apply to them character
    const ok=parseAndApply(themState,msg.item);
    if(ok){
      themState.items.push(msg.item.toLowerCase());
      addTag('them',msg.item);
      const s=calcScore(themState);
      g('themScore').textContent=s+' pts';
    }
  }
  if(msg.type==='reset'){
    resetChar(themState,'them');
  }
  if(msg.type==='theme'){
    currentThemeIdx=msg.themeIdx;
    applyThemeUI();
    showPhaseAnim();
    resetBothChars();
    startTimer();
  }
  if(msg.type==='judge'){
    judgeDisplay(msg.s1,msg.s2,msg.n1,msg.n2);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCREENS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  g(id).classList.add('active');
}
function goHome(){stopTimer();showScreen('homeScreen');}

function showCreate(){
  roomCode=Math.random().toString(36).substring(2,6).toUpperCase();
  g('roomCodeDisplay').textContent=roomCode;
  myRole='host';
  myName=g('createName').value||'Player 1';
  initHost(roomCode);
  showScreen('createScreen');
}

function copyCode(){
  navigator.clipboard.writeText(roomCode).then(()=>{
    const btn=document.querySelector('.copy-btn');
    btn.textContent='‚úÖ Copied!';
    setTimeout(()=>btn.textContent='üìã Copy Code',2000);
  }).catch(()=>{
    // fallback
    prompt('Share this code with your friend:',roomCode);
  });
}

function showJoin(){ showScreen('joinScreen'); }

function joinRoom(){
  const code=g('joinCodeIn').value.trim().toUpperCase();
  if(code.length<3){g('joinMsg').textContent='Please enter a valid code!';return;}
  roomCode=code;
  myRole='guest';
  myName=g('joinName').value||'Player 2';
  g('myNameDisplay').textContent=myName;
  g('joinMsg').textContent='üîó Connecting‚Ä¶';
  g('joinMsg').style.color='#9333ea';
  initGuest(roomCode);
  // Once connected, send join message
  // We poll for conn.open since PeerJS connection is async
  let attempts=0;
  const tryJoin=setInterval(()=>{
    attempts++;
    if(conn && conn.open){
      clearInterval(tryJoin);
      send('join',{name:myName});
      g('joinMsg').textContent='‚úÖ Connected! Starting game‚Ä¶';
      g('joinMsg').style.color='#15803d';
      applyThemeUI();
      setTimeout(()=>showScreen('gameScreen'),800);
    } else if(attempts>15){
      clearInterval(tryJoin);
      g('joinMsg').textContent='‚ùå Could not connect. Check the code and try again!';
      g('joinMsg').style.color='#b91c1c';
    }
  },600);
}

function startGame(){
  myName=g('createName').value||'Player 1';
  g('myNameDisplay').textContent=myName;
  currentThemeIdx=Math.floor(Math.random()*THEMES.length);
  send('start',{themeIdx:currentThemeIdx});
  applyThemeUI();
  showScreen('gameScreen');
  showPhaseAnim();
  startTimer();
}

function playSolo(){
  myRole='solo';
  myName='Player 1';
  themName='Player 2';
  g('myNameDisplay').textContent=myName;
  g('themNameDisplay').textContent=themName;
  g('themWaiting').textContent='‚Üê Type in their box below on another device, or pass the phone!';
  currentThemeIdx=0;
  applyThemeUI();
  showScreen('gameScreen');
  showPhaseAnim();
  startTimer();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyMy(){
  const inp=g('myIn');
  const val=inp.value.trim();
  if(!val)return;
  const ok=parseAndApply(myState,val);
  const fb=g('myFb');
  if(ok){
    fb.textContent='‚ú® '+val+'!';
    fb.className='pfb ok';
    myState.items.push(val.toLowerCase());
    addTag('my',val);
    g('myScore').textContent=calcScore(myState)+' pts';
    send('item',{item:val});
    inp.value='';inp.focus();
  } else {
    fb.textContent='ü§î Try: pink dress, crown, 2 braids‚Ä¶';
    fb.className='pfb err';
  }
  setTimeout(()=>{fb.textContent='';fb.className='pfb';},2500);
}

function addTag(who,label){
  const row=g(who==='my'?'myTags':'themTags');
  const t=document.createElement('div');
  t.className='ptag';
  t.textContent=label;
  row.appendChild(t);
}

function typeHint(val){ g('myIn').value=val; g('myIn').focus(); }

function applyThemeUI(){
  const t=THEMES[currentThemeIdx];
  g('gThemeName').textContent=t.name;
  g('gThemeKw').textContent=t.kw.join(' ¬∑ ');
}

function showPhaseAnim(){
  const t=THEMES[currentThemeIdx];
  g('phaseEmoji').textContent=t.emoji;
  g('phaseBig').textContent=t.name;
  g('phaseKw').textContent='Keywords: '+t.kw.join(', ');
  const ps=g('phaseScreen');
  ps.classList.add('show');
  setTimeout(()=>ps.classList.remove('show'),2800);
}

function judgeNow(){
  stopTimer();
  const s1=calcScore(myState), s2=calcScore(themState);
  const n1=myName, n2=themName;
  send('judge',{s1,s2,n1,n2});
  judgeDisplay(s1,s2,n1,n2);
}

function judgeDisplay(s1,s2,n1,n2){
  const theme=THEMES[currentThemeIdx];
  g('rN1').textContent=n1; g('rN2').textContent=n2;
  g('rS1').textContent=s1+'%'; g('rS2').textContent=s2+'%';
  let winner,trophy,reason;
  if(s1>s2){winner=n1;trophy='üèÜ';reason=`${n1} matched ${theme.name} better! ${s1}% vs ${s2}%`;}
  else if(s2>s1){winner=n2;trophy='üèÜ';reason=`${n2} matched ${theme.name} better! ${s2}% vs ${s1}%`;}
  else{winner='Tie!';trophy='ü§ù';reason=`Both scored ${s1}% ‚Äî it's a perfect tie!`;}
  g('rTrophy').textContent=trophy;
  g('rTitle').textContent=winner==='Tie!'?'It\'s a Tie!':winner+' Wins!';
  g('rWinner').textContent=winner==='Tie!'?'üëØ Amazing ‚Äî you both nailed it!':'üéâ Style Queen: '+winner+'!';
  g('rReason').textContent=reason;
  g('overlay').classList.add('show');
  if(winner!=='Tie!')confetti(50);
}

function nextRound(){
  g('overlay').classList.remove('show');
  const idx=Math.floor(Math.random()*THEMES.length);
  currentThemeIdx=idx;
  send('theme',{themeIdx:idx});
  applyThemeUI();
  showPhaseAnim();
  resetBothChars();
  startTimer();
}

function newThemeHost(){
  if(myRole==='guest')return;
  const idx=Math.floor(Math.random()*THEMES.length);
  currentThemeIdx=idx;
  send('theme',{themeIdx:idx});
  applyThemeUI();
  showPhaseAnim();
  resetBothChars();
  startTimer();
}

function resetMe(){
  resetChar(myState,'my');
  send('reset');
}

function resetChar(st,who){
  const pf=st.prefix;
  Object.assign(st,{hairStyle:'default',hairColor:'#8B5A2B',topColor:pf==='m'?'#FFB3C8':'#a5b4fc',skirtColor:pf==='m'?'#FF85A1':'#818cf8',shoeColor:'#E8547A',accs:{},items:[]});
  renderHair(st);
  doTop(st,st.topColor);
  doSkirt(st,st.skirtColor,'default');
  doShoes(st,'#E8547A','flat');
  g(`${pf}HE`).innerHTML='';g(`${pf}AC`).innerHTML='';g(`${pf}HA`).innerHTML='';
  g(who==='my'?'myTags':'themTags').innerHTML='';
  g(who==='my'?'myScore':'themScore').textContent='0 pts';
  doBlush(st); // reset cheeks
  g(`${pf}CkL`).setAttribute('fill','rgba(255,133,161,0.25)');
  g(`${pf}CkR`).setAttribute('fill','rgba(255,133,161,0.25)');
}

function resetBothChars(){
  resetChar(myState,'my');
  resetChar(themState,'them');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startTimer(){
  stopTimer();
  timeLeft=180;
  updateTimer();
  timerInterval=setInterval(()=>{timeLeft--;updateTimer();if(timeLeft<=0){stopTimer();judgeNow();}},1000);
}
function stopTimer(){clearInterval(timerInterval);timerInterval=null;}
function updateTimer(){
  const m=Math.floor(timeLeft/60);
  const s=String(timeLeft%60).padStart(2,'0');
  g('timerNum').textContent=m+':'+s;
  g('timerFill').style.width=(timeLeft/180*100)+'%';
  g('timerFill').style.background=timeLeft>30?'linear-gradient(90deg,#f472b6,#818cf8)':'linear-gradient(90deg,#ef4444,#f97316)';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFETTI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function confetti(n){
  const cols=['#FF85A1','#FFD700','#c4b5fd','#6ee7b7','#fb923c','#f472b6','#60a5fa'];
  for(let i=0;i<n;i++){
    const c=document.createElement('div');
    c.className='cf';
    c.style.left=Math.random()*100+'vw';
    c.style.top='-20px';
    c.style.background=cols[Math.floor(Math.random()*cols.length)];
    c.style.animationDelay=Math.random()*0.8+'s';
    c.style.width=(7+Math.random()*9)+'px';
    c.style.height=(7+Math.random()*9)+'px';
    c.style.borderRadius=Math.random()>0.5?'50%':'3px';
    document.body.appendChild(c);
    setTimeout(()=>c.remove(),2800);
  }
}
</script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</body>
</html>
